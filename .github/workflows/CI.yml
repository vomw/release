name: Build and Upload Telex-Client

on:
  push:
    branches:
      - main  

jobs:
  build:
    runs-on: ubuntu-latest  # We'll use an Ubuntu environment as MINGW and MSYS are not supported

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    - name: Install necessary tools
      run: |
        sudo apt-get update
        sudo apt-get install -y mingw-w64

    - name: Set up environment and build telex-client
      run: |
        mkdir $HOME/telex
        mkdir $HOME/telex/local
        export LDFLAGS="-L$HOME/telex/local/lib"
        export CFLAGS="-I$HOME/telex/local/include"
        cd $HOME/telex
        tar xf $HOME/telex-client.tar.gz
        cd openssl-1.0.0d
        patch -p1 < ../telex-client/openssl-1.0.0d-telex.patch
        ./config no-shared no-hw no-asm --prefix=$HOME/telex/local/ --openssldir=$HOME/telex/local/
        make
        make install
        cd $HOME/telex
        tar xf ../libevent-2.0.12-stable.tar.gz 
        cd libevent-2.0.12-stable
        ./configure --prefix=$HOME/telex/local --disable-shared
        make
        make install
        cd $HOME/telex
        tar xf ../argtable2-13.tar.gz
        cd argtable2-13
        ./configure --prefix=$HOME/telex/local
        make
        make install
        cd $HOME/telex/telex-client
        CC=gcc make -f Makefile.w32

    - name: Upload Binary
      uses: actions/upload-artifact@v2
      with:
        name: telex-client
        path: $HOME/telex/telex-client/telex-client.exe
